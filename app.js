// Firebase modulok (CDN)
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
import {
  getFirestore, collection, addDoc, serverTimestamp,
  query, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

// üîë a TE Firebase configod
const firebaseConfig = {
  apiKey: "AIzaSyDhV4g-7V2SW-ygR41jkERJgzsHtv9_S4Q",
  authDomain: "websy-velemenyek.firebaseapp.com",
  projectId: "websy-velemenyek",
  storageBucket: "websy-velemenyek.appspot.com",
  messagingSenderId: "47514318127",
  appId: "1:47514318127:web:403255ebaa6eb72478ddda"
};

// Init
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// Anon auth
try { await signInAnonymously(auth); } catch(e){ console.warn('Anon auth hiba:', e.message); }

// DOM
const form = document.getElementById('reviewForm');
const list = document.getElementById('reviewsList');
const tickerInner = document.getElementById('tickerInner');

// Fallback DEM√ì v√©lem√©nyek (max 5)
const DEMO = [
  { name: "M√°rk",  rating: 5, text: "Gyors √©s profi munka, aj√°nlom mindenkinek!" },
  { name: "Kata",  rating: 5, text: "Sz√©p diz√°jn, mobilon is nagyon j√≥l m≈±k√∂dik." },
  { name: "√Åd√°m",  rating: 4, text: "Rengeteget seg√≠tett, k√∂sz√∂n√∂m!" },
  { name: "Lilla", rating: 5, text: "Sokkal t√∂bb lead j√∂n be most." },
  { name: "Norbi", rating: 5, text: "Modern √©s gyors oldal, full el√©gedett vagyok." },
];

// escape
const esc = s => (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

// mini konfetti
function burstFrom(el){
  const n=14, box=el.getBoundingClientRect();
  for(let i=0;i<n;i++){
    const p=document.createElement('span');
    p.style.position='fixed';
    p.style.width=p.style.height='6px';
    p.style.left=(box.left+box.width/2)+'px';
    p.style.top=(box.top+box.height/2)+'px';
    p.style.background=['#a855f7','#6366f1','#22d3ee'][i%3];
    p.style.borderRadius='2px'; p.style.pointerEvents='none';
    document.body.appendChild(p);
    const dx=(Math.random()-0.5)*240, dy=(Math.random()-0.6)*240;
    p.animate([{transform:'translate(0,0)',opacity:1},{transform:`translate(${dx}px,${dy}px)`,opacity:0}],{duration:700+Math.random()*300,easing:'cubic-bezier(.2,.7,.3,1)'}).finished.then(()=>p.remove());
  }
}

// submit ‚Üí Firestore
form.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const fd = new FormData(form);
  const name = (fd.get('name')+'').trim();
  const text = (fd.get('text')+'').trim();
  const rating = parseInt(fd.get('rating'),10)||5;
  if(!name || !text) return;

  burstFrom(form);

  await addDoc(collection(db,'reviews'),{
    name, text, rating, ts: serverTimestamp()
  });
  form.reset();
});

// ----------- V√©gtelen ticker kezel√©se -----------
let tickerTween;

// render helper -> fel√©p√≠ti a list√°kat √©s ind√≠tja az animot
function renderRows(rows){
  // t√∂rl√©s
  list.innerHTML = '';
  tickerInner.innerHTML = '';

  rows.forEach(r=>{
    const safeName = esc(r.name || 'N√©v n√©lk√ºl');
    const safeText = esc(r.text || '');
    const rating = Math.max(1, Math.min(5, r.rating|0 || 5));
    const stars = '‚òÖ'.repeat(rating) + '‚òÜ'.repeat(5-rating);

    // nagy k√°rtya (ha k√©s≈ëbb vissza akarod kapcsolni)
    const card = document.createElement('div');
    card.className = 'glass p-5 rounded-2xl';
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="font-semibold">${safeName}</div>
        <div class="text-yellow-400 text-sm">${stars}</div>
      </div>
      <p class="text-slate-300 text-sm mt-3">${safeText}</p>`;
    list.appendChild(card);

    // ticker sor (grid: n√©v | csillag | sz√∂veg)
    const row = document.createElement('div');
    row.className = 'glass px-4 py-3 rounded-xl';
    row.innerHTML = `
      <span class="text-sm">${safeName}</span>
      <span class="text-xs text-yellow-400 text-center">${'‚òÖ'.repeat(rating)}</span>
      <span class="text-slate-300 text-sm">${safeText}</span>`;
    tickerInner.appendChild(row);
  });

  runTicker(); // indul az anim
}

function runTicker(){
  if(!tickerInner) return;
  if(tickerTween){ tickerTween.kill(); tickerTween = null; }

  const childCount = tickerInner.children.length;
  if(childCount === 0) return;

  // dupl√°z√°s a nahtalan loophoz
  const clones = Array.from(tickerInner.children).map(n => n.cloneNode(true));
  clones.forEach(cl => tickerInner.appendChild(cl));

  const wrapH = tickerInner.parentElement.getBoundingClientRect().height || 200;
  const dist = tickerInner.scrollHeight / 2; // az ‚Äûeredeti‚Äù blokk magass√°ga

  // ha nem el√©g magas a tartalom, anim n√©lk√ºl is ok√© ‚Äì de l√°tsz√≥djon
  if(dist <= wrapH * 0.6){
    gsap.set(tickerInner, { y: 0 });
    return;
  }

  gsap.set(tickerInner,{y:0});
  tickerTween = gsap.to(tickerInner,{
    y: -dist,
    duration: Math.max(15, dist/40),
    ease: 'none',
    repeat: -1,
    onRepeat: () => gsap.set(tickerInner,{y:0})
  });
}

// ----------- Firestore live + fallback -----------
const q = query(collection(db,'reviews'), orderBy('ts','desc'));
onSnapshot(q,(snap)=>{
  const rows = [];
  snap.forEach(doc => rows.push(doc.data()));

  if(rows.length === 0){
    // nincs adat ‚Üí dem√≥
    renderRows(DEMO);
  } else {
    renderRows(rows);
  }

  // resizen √∫jrakalkul√°l
  let to;
  window.addEventListener('resize', ()=>{
    clearTimeout(to);
    to = setTimeout(runTicker, 200);
  }, { once: true });
});
