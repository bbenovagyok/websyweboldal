<!DOCTYPE html>
<html lang="hu">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Websy Analytics</title>
    <meta name="robots" content="noindex, nofollow">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a3e 100%);
            min-height: 100vh;
        }

        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-card {
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }
    </style>
</head>

<body class="text-white p-6">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
            <div>
                <h1 class="text-3xl font-bold">üìä Websy Analytics</h1>
                <p class="text-slate-400 text-sm mt-1">Egyszer≈± l√°togat√°s statisztik√°k</p>
            </div>
            <a href="/" class="text-purple-400 hover:underline text-sm">‚Üê Vissza a f≈ëoldalra</a>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass rounded-xl p-5 stat-card">
                <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Ma</div>
                <div id="todayCount" class="text-3xl font-bold text-purple-400">-</div>
                <div class="text-slate-500 text-xs">l√°togat√≥</div>
            </div>
            <div class="glass rounded-xl p-5 stat-card">
                <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">Tegnap</div>
                <div id="yesterdayCount" class="text-3xl font-bold text-blue-400">-</div>
                <div class="text-slate-500 text-xs">l√°togat√≥</div>
            </div>
            <div class="glass rounded-xl p-5 stat-card">
                <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">H√©ten</div>
                <div id="weekCount" class="text-3xl font-bold text-green-400">-</div>
                <div class="text-slate-500 text-xs">l√°togat√≥</div>
            </div>
            <div class="glass rounded-xl p-5 stat-card">
                <div class="text-slate-400 text-xs uppercase tracking-wider mb-1">√ñsszesen</div>
                <div id="totalCount" class="text-3xl font-bold text-amber-400">-</div>
                <div class="text-slate-500 text-xs">l√°togat√≥</div>
            </div>
        </div>

        <!-- Last 7 Days Chart -->
        <div class="glass rounded-xl p-6 mb-8">
            <h2 class="text-lg font-semibold mb-4">Utols√≥ 7 nap</h2>
            <div id="chartContainer" class="flex items-end justify-between gap-2 h-40">
                <!-- Bars will be inserted here -->
            </div>
        </div>

        <!-- Recent Visits -->
        <div class="glass rounded-xl p-6">
            <h2 class="text-lg font-semibold mb-4">Legut√≥bbi l√°togat√°sok</h2>
            <div id="recentVisits" class="space-y-4 text-sm">
                <div class="text-slate-400">Bet√∂lt√©s...</div>
            </div>
        </div>

        <!-- Loading indicator -->
        <div id="loading" class="fixed inset-0 bg-black/50 flex items-center justify-center">
            <div class="text-xl">‚è≥ Bet√∂lt√©s...</div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import {
            getFirestore, collection, query, orderBy, limit, getDocs, where, Timestamp
        } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhV4g-7V2SW-ygR41jkERJgzsHtv9_S4Q",
            authDomain: "websy-velemenyek.firebaseapp.com",
            projectId: "websy-velemenyek",
            storageBucket: "websy-velemenyek.appspot.com",
            messagingSenderId: "47514318127",
            appId: "1:47514318127:web:403255ebaa6eb72478ddda"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Mark this device as Admin to exclude from tracking
        localStorage.setItem('websy_admin', 'true');

        // Helper: get start of day
        function startOfDay(d) {
            const start = new Date(d);
            start.setHours(0, 0, 0, 0);
            return start;
        }

        async function loadStats() {
            try {
                const visitsRef = collection(db, "visits");

                // Get all visits
                const allVisitsSnap = await getDocs(query(visitsRef, orderBy("ts", "desc"), limit(100)));
                const visits = [];
                allVisitsSnap.forEach(doc => {
                    const data = doc.data();
                    if (data.ts) {
                        visits.push({
                            id: doc.id,
                            ts: data.ts.toDate(),
                            page: data.page || '/',
                            city: data.city || 'Ismeretlen',
                            country: data.country || 'Ismeretlen'
                        });
                    }
                });

                const now = new Date();
                const today = startOfDay(now);
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);

                // Calculate stats
                const todayVisits = visits.filter(v => v.ts >= today);
                const yesterdayVisits = visits.filter(v => v.ts >= yesterday && v.ts < today);
                const weekVisits = visits.filter(v => v.ts >= weekAgo);

                document.getElementById('todayCount').textContent = todayVisits.length;
                document.getElementById('yesterdayCount').textContent = yesterdayVisits.length;
                document.getElementById('weekCount').textContent = weekVisits.length;
                document.getElementById('totalCount').textContent = visits.length;

                // Build 7-day chart
                const chartData = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const nextD = new Date(d);
                    nextD.setDate(nextD.getDate() + 1);
                    const count = visits.filter(v => v.ts >= d && v.ts < nextD).length;
                    chartData.push({
                        date: d,
                        label: d.toLocaleDateString('hu-HU', { weekday: 'short' }),
                        count
                    });
                }

                const maxCount = Math.max(...chartData.map(d => d.count), 1);
                const chartContainer = document.getElementById('chartContainer');
                chartContainer.innerHTML = chartData.map(d => `
          <div class="flex-1 flex flex-col items-center gap-1">
            <div class="text-xs text-slate-400">${d.count}</div>
            <div class="w-full bg-purple-500/80 rounded-t transition-all" 
                 style="height: ${(d.count / maxCount) * 100}%"></div>
            <div class="text-xs text-slate-500">${d.label}</div>
          </div>
        `).join('');

                // Recent visits
                const recentContainer = document.getElementById('recentVisits');
                if (visits.length === 0) {
                    recentContainer.innerHTML = '<div class="text-slate-400">M√©g nincs l√°togat√°s r√∂gz√≠tve.</div>';
                } else {
                    recentContainer.innerHTML = visits.slice(0, 20).map(v => `
            <div class="flex justify-between items-center py-2 border-b border-white/5">
                <div class="flex flex-col">
                    <span class="text-slate-300 font-medium">${v.page}</span>
                    <span class="text-slate-500 text-xs">${v.city}, ${v.country}</span>
                </div>
                <span class="text-slate-500 text-xs text-right">${v.ts.toLocaleString('hu-HU')}</span>
            </div>
          `).join('');
                }

                document.getElementById('loading').classList.add('hidden');

            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('loading').innerHTML = `
          <div class="text-center">
            <div class="text-xl mb-2">‚ùå Hiba</div>
            <div class="text-sm text-slate-400">${error.message}</div>
          </div>
        `;
            }
        }

        loadStats();
    </script>
</body>

</html>